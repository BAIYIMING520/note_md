# 计算机网络
- [ch01-计网体系结构](#ch01-%e8%ae%a1%e7%bd%91%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84)
  - [网络基本概念](#%e7%bd%91%e7%bb%9c%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5)
  - [性能参数[带宽 &amp; 时延]](#%e6%80%a7%e8%83%bd%e5%8f%82%e6%95%b0%e5%b8%a6%e5%ae%bd-amp-%e6%97%b6%e5%bb%b6)
  - [习题:](#%e4%b9%a0%e9%a2%98)
- [ch1-2 直连网络技术](#ch1-2-%e7%9b%b4%e8%bf%9e%e7%bd%91%e7%bb%9c%e6%8a%80%e6%9c%af)
  - [调制, 编码, 成帧](#%e8%b0%83%e5%88%b6-%e7%bc%96%e7%a0%81-%e6%88%90%e5%b8%a7)
  - [信道共享技术](#%e4%bf%a1%e9%81%93%e5%85%b1%e4%ba%ab%e6%8a%80%e6%9c%af)
  - [差错控制技术](#%e5%b7%ae%e9%94%99%e6%8e%a7%e5%88%b6%e6%8a%80%e6%9c%af)
  - [习题](#%e4%b9%a0%e9%a2%98)
- [ch02-IPv6](#ch02-ipv6)
  - [IPv6报文结构](#ipv6%e6%8a%a5%e6%96%87%e7%bb%93%e6%9e%84)
  - [IPv6地址](#ipv6%e5%9c%b0%e5%9d%80)

## ch01-计网体系结构

### 网络基本概念

计算机网络的需求:

- 连通性: 
  - 逻辑链路: 两点间通过通信协议的作用建立起的数据联结通路
  - 通路: 从源点到宿点所经过的一串节点和链路的有序集,或端到端的通路
  - 协议: 多个进程为完成一个任务而共同遵守的动作序列规范; 三要素:语法,语义,规则
- 为用户提供高效的资源分享
- 为开发者支持常用服务

网络体系结构
- 本质: 将复杂事物分解成元素和结构,结构描述元素之间的关系
- 元素: 协议 协议之间的关系: 分层
  - 协议定义服务接口--对上层的操作, p2p接口--和其他主机上的同层协议新信息交换
- 不同任务在不同层次, 同一层次可以有不同的抽象

OSI七层结构: 物理层, 链路层, 网络层, 运输层, 会话层, 表示层, 应用层

Internet结构
- 第一层: 中转网 backbone
- 第二层: 地区性网 Transit
- 第三层: 组织性网 Stub: 本地服务提供商

### 性能参数[带宽 & 时延]

带宽: Hz, KHz, MHz, bps
- 信号带宽: 频率范围, Hz
- 媒体带宽: 通信媒体允许通过的信号频带范围
- 通信链路: 比特率, 某时段内网络上可能传输的比特数, 习惯把带宽作为数字信道的数据率或比特率
- 比特率越高, 高频分量越多, 频率范围越大,信号带宽越高

吞吐率: bps
- 数字信号的发送速率, 发送带宽也称为吞吐率
- 与带宽的区别: 带宽是吞吐率的上限, 吞吐率是链路上实际每秒传输的比特数(测量性能)

延迟: 把一个报文从网络的一端传输到另一端所需的时间
- 延迟=处理+排队+传输+传播(主要考虑后两个)
- 处理时延: 检查包首部,决定导向何处, 比特差错检测,接受完整的一个分组的时间=包容量/链路速率
- 排队时延: 等待输出链路空闲
- 传输时延: 数量/带宽, 微秒到毫秒
- 传播时延: 距离/光速, 广域网中是毫秒级

传输/传播比较:
- 传输是将数据包从路由器发到链路上的时间
- 传播是数据包在链路上传播所需的时间

RTT: 发收来回那2次时延

端到端吞吐率计算:(**注意传输时间用RTT算**: 因为不仅包括单程时延,还包括了请求或建立连接的附加时间)
- 端到端吞吐率 = 实际传输大小/传输时间
- 传输时间 = RTT+传输大小/信道带宽
- RTT: 请求与回答的间隔时间

带宽和时延对于不同大小的对象和带宽的影响: 小数据时延迟支配带宽, 大数据时带宽支配延迟
![](pictures/computer_networks/ch1_1.png)

延迟带宽积: 信道管道的体积,链路上所容纳的比特数

传输可靠性:
- 数据最小颗粒能正确到达
- 数据不同分片能有序到达

网络涉及者需要考虑的三个类型的故障
- 链路上的单比特错, 突发连续比特错
- 包错: 一个包在网络上丢失
- 节点链路级故障
QoS
- 连通性
- 吞吐量, 带宽 (记性参数)
- 延迟, 延迟抖动
- 丢包, 丢包率(乘性参数)
- 可靠性, 可用性 (乘性参数)

### 习题:

1. 一局域网最大距离为2KM，对于100Byte的数据包，在带宽为多少时，传播时延等于传输时延？512Byte的数据包呢？

    传播时延 = 2km / 3*10^8m/s = 0.667*10^-5s\
    传输时延 = 数据大小/带宽 = 100*8 / BW = 传播时延\
    BW = 120 Mbps\
    BW = 614.4 Mbps

2. 假设在地球和月球间建立一点对点100MPS的连接，地月距离为385,000KM，数据传播速度为光速（3*108M/S）
- A．计算最小的RTT
- B．use the RTT as the delay , calculate the delay*bandwidth product for the link
- C. 在B中计算的delay*bandwidth有何意义？
- D．在月球照的照片，并以数字格式存在磁盘上。如果地球上的控制中心想下载25M的最新的图形，那么从发出数据到传输完成所要的最小时间是多少
  
    A. RTT = 3.85*10^8 / 3*108 * 2 = 2.56 s\
    B. DBP = 1 * 10^8 * 2.56 = 0.32MB\
    C. 信道中存在的最大数据量\
    D. 25*8 / 100 + RTT = 2 +　２.56 = 4.56s

## ch1-2 直连网络技术

链路传输能力上限(香农定理): 传输能力和带宽B, 功率S, 平均信噪N存在关系$C=B log_2(1+\frac{S}{N})$, $dB=10*log_10(S/N)$

主干线路带宽: SONET 光网络
- SONET的帧决定了传输速率
- 同步光纤网通过分时来加快传输速率, 达到10G后引入分频的光波复用技术(单一信道的传输速率不超过10G)

### 调制, 编码, 成帧

信号调制: 修改信号的幅度, 频率和相位及其组合形式来标示和携带数据信息的过程

调制原因:
- 信噪比高, 传输能力大, 影响信号的噪声在不同的频率强度不完全相同
- 将原始信号移到噪声强度最低的频率,可以获得更高的传输能力, 调制使用的载波选择系统噪声强度最低的区域的频率

编码:
- 信号的物理层处理: 模拟->模拟(调制), 模拟->数字(编码), 数字->数字(编码), 数字->模拟(调制)
- bit的逻辑层编码: 4B/5B, 8B/10B, 64B/66B

比特率vs波特率:
- 比特率 bps=bit/s, 每秒传输的比特数
- 波特率 Buad, 每秒为表示某些比特而需要传输的信道单元数(码元数)
- 当仅当一个信号单元表示一个比特时,比特率等于波特率
- 通常一个码元--一个模拟信号波形可以表示多个bit

逻辑层编码(数字->数字): 信号中的连续0或连续1造成(1)信号平均值漂移(2)信号时钟不同步
- 基本NRZ: 0 低电平 1 高电平 (存在上述问题)
- NRZI: 1 电平变化 0 电平不变 (解决了连续1问题)
- Manchester编码: 0 低->高 1 高->低 (存在的问题, 信号传输率变成了两倍, 比特率是波特率的一半)
- 4B/5B: 将4bit映射到5bit, 使得头上不超过一个0, 结尾不超过2个0, 因此整个信号不会超过连续的3个0, 得到的再通过NRZI进行编码
- 差分曼码, 0位跳变, 之后0位或1位都会发生一次电平变化
- 8B/10B: 1G光传输
- 64B/66B: 10G光传输

以太网使用曼码, 差分曼码比曼码更容易检测,更适合高速传输, 两种码效率都只能达到50%左右, 而4B/5B+NRZI的效率是80%左右

成帧: 点到点链路间的一块有界数据,(有界是为了同步和共享)

帧: Frame 一个在具体网络第二层实现的,与硬件有关的特殊分组, 网上传输的最小单元, frame=数据部分+发送接收的**物理地址**+处理控制部分 [帧头 + 数据 + 帧尾]

成帧协议
- 面向字节(Byte)的协议: 
  - 面向字符终端, BISYNC, DDCMP, PPP/SLIP
- 面向比特(bit)协议:
  - 不关心字节的边界
  - 帧看做比特的集合
  - SDLC
- 如果body/payload中包含特殊字符(控制字符)
  - 字符转义, 加上一个转义符
  - 比特转义, 零比特插入
- SONET基于时钟的帧
  - 线路速率都是51.84Mbps的整数倍
  - 帧长度不依赖数据
  - 基本的SONET有无数据都是每秒8000帧, 每帧前三列作为系统管理信息,帧头开销3.3%
  - SONET的段开销的头两个字节也会出现在payload中, 但是不用做转义, 因为是固定长度的帧
  - STS的分时复用将时钟提高3倍, 让接收器仍然是每秒接受8000帧, 用多个复用的接收器(字节交叉的多路复用)
  - 帧前两个字节包含一个特定的比特模式,表示帧开始, 由于不进行比特插入, 可能出现在payload, 接收方希望它每810个字节出现一次

HDLC(面向bit的协议)
- 用01111110表示帧的开始和结束
- 任意时刻从消息体发出的5个连续的1后在发送下一个bit之前插入一个0
- 接收方: 如果5个连续的1到达, 如果下一个是0, 则去掉, 如果下一个是1, 查看下一个bit,如果是0,那么它是一个帧结束的标记;如果是1, 一定是出错, 丢弃整个帧, 接收方需要等到下一个01111110出现后才能再次开始接收

### 信道共享技术
复用: 把共享信道划分成多个子信道, 每个子信道传输一路数据

复用方法:
- 时分复用TDM
- 频分复用FDM
- 波分复用WDM 光纤
- 码分复用CDM 手机信号


### 差错控制技术
差错控制: 在通信中发现检测和纠正差错

为何要差错控制: 不存在理想信道->传输总会出错

产生差错的原因:
- 信号衰减和热噪声
- 信道的电气特性引起的信号幅度频率,相位的畸变
- 信号的反射和串扰
- 冲击噪声, 闪电, 大功率电器的启停

基本思想: 发方编码 收方检错 能纠就纠 不能则重传

基本方法: 收方差错检测, 并告知发送方是否正确接收

差错控制技术: 自动重传ARQ: 停等ARQ(发一等一, 重传刚才出错的帧), go-back-N ARQ(发送N等一个应答, 出错重传错起的所有帧), 选择重传ARQ(发N等一, 只重传出错的帧)

任何检测纠错的基本思想: 加入冗余信息到帧中, 一般为n位信息加入k<< n比特冗余

纠错码主要的编码方式: 奇偶校验 循环冗余校验CRC 校验和

### 习题

1. 1101 1110 1101 1011 1110 1110 1111, 4B/5B编码和对应的NRZI信号

4B/5B: 11011 11100 11011 10111 11100 11100 11101
NRZI: 01101 01000 10010 11010 10111 01000 10110 **[NRZI信号是画图]**

2. 0110 1011 1110 1010 0111 1111 0110 0111 1110 去bit插入, 找出问题
0110 1011 111 1010 **0111 1111 0**110 0111 1110
可能出现了比特传输错

3. (a) xxxDLExxx (b) 01111111

4. SONET

## ch02-IPv6
IPv4存在的问题:
- 地址分配不合理(A, B, C类地址差距悬殊)
- CIDR推出晚, 效果有限[CIDR: 网络号划分]
- 路由表项爆炸
- 头长度不固定, 不利于ASIC处理;没有利用包前后的相关性, 每个包进行相同的处理; MTU导致分段和逐段校验, 路由处理慢
- 无法提供多样的QoS
- 地址限制问题
- 安全支持: 源地址伪造,报文明文, TCP劫持

IPV6主要特征:
- 扩大地址空间, 路由更结构层次化
  - 128bit, 全局unicast=公开地址, 全局CIDR
- 报头格式简化, 长度固定, 方便硬件处理, 引入结构化扩展报头
- 网络管理简化: 自动发现和自动配置, 最大单元发现(MTU), 邻接节点发现, 路由通告, 路由请求, 节点自动配置
- 安全性支持: IPSec, 认证头(AH), 安全荷载封装(ESP)
- QoS能力: 使用流标号
- 多播寻址: 允许区分永久性多播地址和临时性多播地址
- 可移动性

### IPv6报文结构

![](pictures/computer_networks/ch2_1.png)

主要改变:
- 对齐: 32bit整数倍->64bit整数倍
- 取消报头长度字段, 固定报头长度40Bytes
- Total length -> Payload Length
- 源地址字段增加到每个字段16bytes
- 分片信息移到扩展报头中
- 生存时间TTL改名为Hop limit
- 业务类型改为数据流标号flow label字段
- 协议字段改为下一个报头字段, 以指明下一个报头类型

通信类别(TrafficClass)与流标号(FlowLabel): 都与QoS有关; 通信类别由应用层填充, 上层协议不能假定心愿填充的值不变, 宿端收到的值可能与源端不一样; 数据流标号支持资源预定

NextHeader代替IP选项和Protocol字段, 当没有特殊首部时,该位置填写TCP或UDP

扩展报头: 选项功能放在了扩展报头, 中间路由器除了逐跳扩展(Hop-By-Hop Options)和源路由选择扩展(Routing), 都不处理
- 逐跳扩展主要是巨型荷载选项, 报文长度最长达4G

### IPv6地址

地址模式
- 地址分配到接口: 单个接口可能分配有任何单播, 任播, 组播地址
- 地址有范围之分
  - Link local: 必须配置, fe开头, 访问同一局域网内IP
  - Site Local: 相当于IPv4的私有地址, 不被全局路由, 后被取消
  - Global
- 地址有寿命: 有效/永久, 临时地址用于访问别人(隐私策略, 快速老化自动分配)
- 地址结构: 前缀+接口ID
- 地址类型: 
  - Unicast: 目的地址指明的单一的计算机
  - Anycast(one to nearest): 目的地址是共享一个IP地址的计算机接口集合, 典型的情况是在不同物理网络上的不同节点, 发送到anycast地址的包将选择这个集合中路由度量距离最近的节点
  - Multicast: 目的地址是一组计算机,典型情况是属于不同网络的不同节点, 代替广播
  - Reserved  

*注: 广播由组播代替.*

|前缀|用途|
|:-:|:-:|
00..0(128位)|未分配
00..1(128位)|回环
1111 1111|多播地址
1111 1110 10|link local
其他|全局单播

保留地址前缀为0000 0000, 包括三类: 全零地址, 回环地址, 嵌入到了IPv4的IPv6地址
- 支持IPv4的地址的前80位为0, 后32为与IPv4地址一致, 中间的16位可能填0或1

unicast地址的特点
- 所有unicast地址必须有64位用于EUI-64的接口ID， 例如64的MAC地址
- unicast地址严格聚类： 分配形式包括全局可聚类地址（001），NASP地址，IPX层次地址，link-local地址，site-local地址，IPv4兼容地址等。
- 基本假设：路由系统基于“最长前缀匹配”选择转发路径
- 可聚类全局地址包括FP，TLA, RES, NLA, SLA, Interface几个段，其中RES是用于以后TLA或NLA扩展到保留字段.在每个机构下,可以继续划分层次
- 顶级路由器理论上只需要维护不超过2^13项表项

link-local地址特点:
- 用于本地链路上的地址分配:自动地址配置, 邻居发现,没有路由器时
- 路由器不会转发该地址到其他链路

IPv6邻居发现协议
- 设计ICMPv6报文: 路由器请求(RS), 路由器通告(RA),邻居请求(NS),邻居通告(NA)
- 邻居发现协议的作用: 路由器发现, 前缀发现,参数发现(MTU等), 地址自动配置, 地址解析(IP<->链路层地址), 下一跳确定,邻居不可达检测(DUD), 地址重复检测(DAD)
- 地址自动配置中 stateless的方法使用邻居发现完成

> 邻居发现协议中的报文, 跳数设置为255, 因为不会有比255更大的数, 所以这个报文没有经过过路由器.

地址自动配置
- stateful地址配置通过路由器完成,在RA中将M位置为1
- client - RS(ff02::2多播)-> router -RA(Flag:managered)-> client -DHCP-Solicitation(ff02::1:2多播)-> DHCP server -> DHCP-A ...

RS/RA
- RS: IP部分,src未定义或link-local, des为组播地址ff02::2;ICMP部分, 选项部分包含发送者的link-local地址
- RA: IP部分, src为link-local地址, 目的地址为全部节点的组播地址FF02::1或RS发送者的地址;ICMP部分, 选项里包含hop limit,发送者链路层地址,MTU,地址前缀等信息, router lifetime-主机默认路由的刷新时间, Reachable time-存在于主机邻居缓存中的时间;Retrans timer-进行邻居检测时的重新发送间隔

NS/NA:
- 用途, 链路层地址解析(等价于ARP), 地址重复检测
- NS: 源地址使用IPv6地址(地址解析)或unspecified(DAD), 目的地址为多播地址(地址解析)或单播地址(可达性), ICMP中选项部分包含发送者链路层地址
- NA: 源地址为发送者IPv6地址, 目的地址为全部节点的组播地址FF02::1(DAD)或NS的单播地址(地址解析); 选项部分包含发送这的链路层信息

IPv6的地址解析
- 在第三层完成, 不同的二层介质看采用相同地址解析协议
- 可以使用第三层的安全协议, 组播方式, 减少二层网络压力



