# 计算机网络

## ch02-IPv6
IPv4存在的问题:
- 地址分配不合理(A, B, C类地址差距悬殊)
- CIDR推出晚, 效果有限[CIDR: 网络号划分]
- 路由表项爆炸
- 头长度不固定, 不利于ASIC处理;没有利用包前后的相关性, 每个包进行相同的处理; MTU导致分段和逐段校验, 路由处理慢
- 无法提供多样的QoS
- 地址限制问题
- 安全支持: 源地址伪造,报文明文, TCP劫持

IPV6主要特征:
- 扩大地址空间, 路由更结构层次化
  - 128bit, 全局unicast=公开地址, 全局CIDR
- 报头格式简化, 长度固定, 方便硬件处理, 引入结构化扩展报头
- 网络管理简化: 自动发现和自动配置, 最大单元发现(MTU), 邻接节点发现, 路由通告, 路由请求, 节点自动配置
- 安全性支持: IPSec, 认证头(AH), 安全荷载封装(ESP)
- QoS能力: 使用流标号
- 多播寻址: 允许区分永久性多播地址和临时性多播地址
- 可移动性

### IPv6报文结构

![](pictures/computer_networks/ch2_1.png)

主要改变:
- 对齐: 32bit整数倍->64bit整数倍
- 取消报头长度字段, 固定报头长度40Bytes
- Total length -> Payload Length
- 源地址字段增加到每个字段16bytes
- 分片信息移到扩展报头中
- 生存时间TTL改名为Hop limit
- 业务类型改为数据流标号flow label字段
- 协议字段改为下一个报头字段, 以指明下一个报头类型

通信类别(TrafficClass)与流标号(FlowLabel): 都与QoS有关; 通信类别由应用层填充, 上层协议不能假定心愿填充的值不变, 宿端收到的值可能与源端不一样; 数据流标号支持资源预定

NextHeader代替IP选项和Protocol字段, 当没有特殊首部时,该位置填写TCP或UDP

扩展报头: 选项功能放在了扩展报头, 中间路由器除了逐跳扩展(Hop-By-Hop Options)和源路由选择扩展(Routing), 都不处理
- 逐跳扩展主要是巨型荷载选项, 报文长度最长达4G

### IPv6地址

地址模式
- 地址分配到接口: 单个接口可能分配有任何单播, 任播, 组播地址
- 地址有范围之分
  - Link local: 必须配置, fe开头, 访问同一局域网内IP
  - Site Local: 相当于IPv4的私有地址, 不被全局路由, 后被取消
  - Global
- 地址有寿命: 有效/永久, 临时地址用于访问别人(隐私策略, 快速老化自动分配)
- 地址结构: 前缀+接口ID
- 地址类型: 
  - Unicast: 目的地址指明的单一的计算机
  - Anycast(one to nearest): 目的地址是共享一个IP地址的计算机接口集合, 典型的情况是在不同物理网络上的不同节点, 发送到anycast地址的包将选择这个集合中路由度量距离最近的节点
  - Multicast: 目的地址是一组计算机,典型情况是属于不同网络的不同节点, 代替广播
  - Reserved  

*注: 广播由组播代替.*

|前缀|用途|
|:-:|:-:|
00..0(128位)|未分配
00..1(128位)|回环
1111 1111|多播地址
1111 1110 10|link local
其他|全局单播

保留地址前缀为0000 0000, 包括三类: 全零地址, 回环地址, 嵌入到了IPv4的IPv6地址
- 支持IPv4的地址的前80位为0, 后32为与IPv4地址一致, 中间的16位可能填0或1

unicast地址的特点
- 所有unicast地址必须有64位用于EUI-64的接口ID， 例如64的MAC地址
- unicast地址严格聚类： 分配形式包括全局可聚类地址（001），NASP地址，IPX层次地址，link-local地址，site-local地址，IPv4兼容地址等。
- 基本假设：路由系统基于“最长前缀匹配”选择转发路径
- 可聚类全局地址包括FP，TLA, RES, NLA, SLA, Interface几个段，其中RES是用于以后TLA或NLA扩展到保留字段.在每个机构下,可以继续划分层次
- 顶级路由器理论上只需要维护不超过2^13项表项

link-local地址特点:
- 用于本地链路上的地址分配:自动地址配置, 邻居发现,没有路由器时
- 路由器不会转发该地址到其他链路

IPv6邻居发现协议
- 设计ICMPv6报文: 路由器请求(RS), 路由器通告(RA),邻居请求(NS),邻居通告(NA)
- 邻居发现协议的作用: 路由器发现, 前缀发现,参数发现(MTU等), 地址自动配置, 地址解析(IP<->链路层地址), 下一跳确定,邻居不可达检测(DUD), 地址重复检测(DAD)
- 地址自动配置中 stateless的方法使用邻居发现完成

> 邻居发现协议中的报文, 跳数设置为255, 因为不会有比255更大的数, 所以这个报文没有经过过路由器.

地址自动配置
- stateful地址配置通过路由器完成,在RA中将M位置为1
- client - RS(ff02::2多播)-> router -RA(Flag:managered)-> client -DHCP-Solicitation(ff02::1:2多播)-> DHCP server -> DHCP-A ...

RS/RA
- RS: IP部分,src未定义或link-local, des为组播地址ff02::2;ICMP部分, 选项部分包含发送者的link-local地址
- RA: IP部分, src为link-local地址, 目的地址为全部节点的组播地址FF02::1或RS发送者的地址;ICMP部分, 选项里包含hop limit,发送者链路层地址,MTU,地址前缀等信息, router lifetime-主机默认路由的刷新时间, Reachable time-存在于主机邻居缓存中的时间;Retrans timer-进行邻居检测时的重新发送间隔

NS/NA:
- 用途, 链路层地址解析(等价于ARP), 地址重复检测
- NS: 源地址使用IPv6地址(地址解析)或unspecified(DAD), 目的地址为多播地址(地址解析)或单播地址(可达性), ICMP中选项部分包含发送者链路层地址
- NA: 源地址为发送者IPv6地址, 目的地址为全部节点的组播地址FF02::1(DAD)或NS的单播地址(地址解析); 选项部分包含发送这的链路层信息

IPv6的地址解析
- 在第三层完成, 不同的二层介质看采用相同地址解析协议
- 可以使用第三层的安全协议, 组播方式, 减少二层网络压力



